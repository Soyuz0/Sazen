# Agent-First Browser Plan

## Product Goal
Build an agent-first Chromium runtime where structured state is primary, actions are atomic/replayable, and humans can watch execution in a visible browser with real-time logs.

## Locked Constraints
- TypeScript implementation.
- Visible Chromium by default (headed mode).
- Real-time logs and action stream.
- Deterministic-first behavior for reproducible testing.
- Structured DOM snapshots with stable IDs.
- Session save/load and trace replay.

## Architecture
Agent -> Control API -> Orchestrator -> Chromium (Playwright + CDP) -> State/Trace Store

- **Control API:** JSON command contract for actions and results.
- **Orchestrator:** Intent -> atomic operations with stable waits/retries.
- **Runtime:** Browser lifecycle, tabs, contexts, mocks.
- **State Layer:** snapshots, diffs, logs, network, timing, artifacts.

## Feature Pillars
1. **Deterministic Execution**
   - Reduced motion + disabled animations.
   - Fixed seed random/time shims.
   - Wait-for-stable heuristics.
   - Trace replay with consistency checks.

2. **Structured DOM Interface**
   - Node IDs, role/name, visibility, interactability, bbox.
   - Stable semantic references.
   - Token-optimized output mode.

3. **Atomic Action API**
   - navigate/click/fill/select/press/wait/snapshot/mock.
   - Every action returns status + dom diff + logs + network + timings.

4. **Observability**
   - Console, network, page errors, request failures.
   - Layout shift + paint/navigation timing collection.
   - Real-time event feed in CLI.

5. **Persistence + Replay**
   - Save storage state + URL checkpoints.
   - Save action traces to disk.
   - Deterministic replay with hash comparison.

## Initial Deliverables (v0)
- Headed Chromium runtime.
- Action execution engine with deterministic mode.
- Structured snapshot + DOM diff engine.
- Real-time logs + network capture.
- CLI (`open`, `run`, `inspect`, `snapshot`, `replay`).
- Trace save/load and replay validation.

## Current Build Status
- Implemented: headed Chromium runtime, atomic action execution, snapshot/diff engine, observer pipeline, trace save/replay, session save/load.
- Implemented CLI: `open`, `inspect`, `describe`, `run`, `act`, `snapshot`, `load`, `profile-save`, `profile-load`, `replay`, `flake`, `timeline`, `timeline-html`, `bundle`, `visual-diff`.
- Implemented deterministic defaults: reduced motion, random/time shims, layout-shift capture.
- Implemented tests: contract + snapshot unit tests, integration tests for real app flow + replay + session load + ambiguous role disambiguation.
- Implemented batch validation runner: `npm run smoke:sites` for sequential multi-site coverage with JSON summary output.
- Implemented replay upgrades: preflight origin checks, strict/relaxed replay modes, selector-level invariants, and repeated-run flake detection.
- Implemented trace metadata upgrades: environment contract (`requiredOrigins`) and action timeline summaries.
- Implemented log noise controls with default filtering and `--raw-logs` override.
- Implemented viewport control via session options/CLI and script action (`setViewport`).
- Implemented agent-first page modality output (`describe`) with positional metadata and issue hints.
- Implemented timeout-guarded site matrix execution (per-operation and per-action timeouts) to prevent hangs.
- Implemented trace timeline inspection command (`timeline`) with tabular and JSON output.
- Implemented assertion DSL (`assert`) with selector/url/title checks.
- Implemented consent helper action (`handleConsent`) for common cookie/consent banners.
- Implemented adaptive stability profiles (`fast`, `balanced`, `chatty`) for wait tuning.
- Implemented triage bundle generation (`bundle`) for trace+timeline+artifact packaging.
- Implemented interactive confidence scoring in agent page descriptions.
- Implemented screenshot modes (`viewport` default, optional `fullpage`) to reduce visual flashing during runs.
- Implemented bundle artifact copy mode (`bundle --copy-artifacts`) for portable triage packages.
- Implemented configurable redaction policy packs (`default`, `strict`, `off`).
- Implemented named profile aliases (`profile-save`, `profile-load`) for reusable authenticated sessions.
- Implemented visual assertion primitives (`selector_bbox_min`, `selector_overlap_max`).
- Implemented interactive timeline HTML report generation (`timeline-html`).
- Implemented screenshot-based visual regression overlays (`visual-diff`).
- Implemented element-aware screenshot annotations for executed actions (target box + center marker).
- Implemented live timeline output during `run` (`--live-timeline`) and JSONL timeline streaming (`--timeline-stream`).
- Implemented pause action (`pause`) with timeout/enter modes and intervention summary metadata.
- Implemented adapter runtime run controls: `pauseSession` / `resumeSession` / `getSessionState` with serialized session operations.
- Implemented in-browser runtime overlay controls (Pause/Resume) wired to session execution state.
- Implemented run-control socket surface for long `run` sessions (`run --control-socket`, `run-control pause|resume|state`).
- Implemented pause intervention journal persistence in traces (`interventions`) with URL/DOM change metadata.
- Implemented timeline provenance markers for run-level pause windows (`pause_start`, `pause_resume`).
- Implemented consent strategy hooks with CMP + site adapters and region-aware variants (`handleConsent` strategy/region/siteAdapter).
- Implemented richer timeline inspector UI in `timeline-html` (grouping, free-text search, detail pane).
- Implemented element-aware visual diff overlays with target boxes and semantic labels in diff artifacts.
- Implemented default-on screenshot context handoff (`.agent-browser/context/latest.json` + `attachments.jsonl`).
- Implemented storage/cookie delta journaling + reconciliation hints inside intervention journal entries.
- Implemented MCP-parity session control aliases in adapter runtime (`session.pause`, `session.resume`, `session.state`).
- Implemented first-class `loop` runner with action->observe->branch flow and optional iteration cap (`loop` command + loop script schema).
- Implemented trace-scoped profile switching action (`switchProfile`) for in-run role transitions.
- Implemented visual baseline assert condition (`assert` + `visual_baseline`) with mismatch thresholding and diff artifacts.

## Validation Strategy
- Build local fixture app for dogfooding.
- Run scripted flow against fixture using visible browser.
- Verify per-action diffs/logs/network bundles.
- Run replay and validate expected vs actual DOM hashes.

## Cross-Site Validation Coverage
- Added multi-site scripted flows in `examples/site-flows` for: example, wikipedia, mdn, nodejs, github, python, vite, hn, rust, bbc, react, books.
- Each flow performs navigation + at least one interaction step (click/fill/search).
- Ran matrix repeatedly; latest full pass: 12/12 successful flows with no new blocking bugs.
- Verified replay behavior on dynamic/public traces: strict mode surfaces real DOM drift, relaxed mode validates stable invariants.
- Final consecutive matrix pass after replay/flake enhancements also succeeded: 12/12 sites, 0 failures.

## Executed Fixes from Cross-Site Runs
- Implemented locator candidate fallback chain (test id, id, href, name attr, role/name, css path).
- Implemented strict-mode disambiguation by defaulting target locators to `.first()` and trying ranked alternatives.
- Implemented stableRef ranking to prefer visible/actionable matches when duplicate semantic refs exist.
- Implemented bounded stability waits to avoid 10s stalls on chatty sites (short network-idle budget + quiet window).
- Improved action resilience by degrading gracefully when post-action snapshot/perf/screenshot capture fails.
- Added ambiguous-target fixture + integration test to prevent regressions in multi-match role targeting.
- Added site matrix runner (`npm run smoke:sites`) and machine-readable summary output.
- Added replay preflight checks to fail fast when required origins are offline.
- Added relaxed replay mode for dynamic sites where strict DOM hashes are too brittle.
- Added flake detection command to surface unstable actions across repeated replays.
- Added selector-level replay invariants (from `waitFor(selector)`) for stronger relaxed-mode validation.
- Added viewport/action support to test behavior across resolutions.
- Added offscreen-aware element ranking and visual issue detection in agent page descriptions.
- Added smoke runner timeout flags (`--operation-timeout-ms`, `--action-timeout-ms`) for safer unattended runs.
- Standardized manual run logs under `reports/runtime-logs/` for reproducible audit trails.
- Added timeline filters/artifact visibility for quicker failure triage.
- Added consent and assert integration coverage in fixture tests.
- Enforced headless-by-default behavior in site matrix runs unless explicitly requested (`--headed`).
- Added optional screenshot copying into bundles for offline handoff.
- Replaced unstable npmjs smoke flow (Cloudflare challenge) with nodejs.org flow for deterministic matrix reliability.
- Replaced unstable ebay smoke flow with books.toscrape flow for deterministic e-commerce-style coverage.
- Added profile command wrappers to simplify session save/load workflows for role-based testing.
- Added CLI-level visual diff thresholding and fail conditions for regression gating.
- Added annotated screenshot artifacts in action results and timeline entries.
- Added pause action coverage in integration tests and action result metadata.
- Added overlay-node exclusion in snapshot capture to keep DOM hashes stable while runtime controls are visible.
- Added integration coverage for run-level pause intervention journaling and trace provenance markers.
- Updated visual diff comparison to ignore pause provenance timeline markers for stable action-to-action alignment.
- Added fixture + integration coverage for region-aware consent handling and context attachment publication.
- Added adapter coverage for MCP-parity control aliases.
- Stabilized github smoke flow by navigating directly to `/login` and validating fill/wait interactions.
- Hardened shutdown paths for `open`/`load`/adapter flows with idempotent close handling and benign close-race suppression.
- Added loop runner integration coverage and fixture flow for branch-on-observation execution.
- Added integration coverage for switching between saved profiles inside a single trace run.
- Added integration coverage for pass/fail visual baseline assertions within regular action scripts.

## Definition of Done (v0)
- Browser visible and usable while automation runs.
- Every action emits structured result envelope.
- Trace save + replay works for deterministic scenarios.
- Session state save/load restores authenticated/local state.
- CLI gives clear, real-time debugging output.

## Continuous Roadmap Additions

## Base Plan Milestones (M1-M3)

### M1 - Run Control Surface (Done)
- Deliverables:
  - CLI `run` exposes control socket (`--control-socket`).
  - New `run-control` command supports `pause`, `resume`, and `state` from a separate process.
  - Control state returns pause sources, elapsed pause time, and run progress metadata.
- Validation:
  - `npm run build`
  - `npm test`
  - Manual: run script + send `run-control state/pause/resume` against socket.

### M2 - Pause Provenance + Intervention Journal (Done)
- Deliverables:
  - Trace persists `interventions` with `pre/post` URL and DOM hash.
  - Timeline includes provenance marker rows: `pause_start` and `pause_resume`.
  - Timeline renderers expose control metadata for auditability.
- Validation:
  - Unit: trace timeline coverage with control markers.
  - Integration: session pause/resume records intervention entry in saved trace.

### M3 - Tooling Compatibility + Baseline Safety (Done)
- Deliverables:
  - Visual diff engine ignores control-marker rows so screenshot step alignment remains stable.
  - Bundle manifest includes intervention journal entries.
  - Overlay controls remain excluded from DOM snapshots/diff hashes.
- Validation:
  - `npm run build`
  - `npm test`
  - Existing replay/visual/timeline suites stay green.

### Near-Term (v0.x) - Remaining
- **Live timeline TUI:** terminal pane with auto-updating action timeline and artifact links during execution.

### Near-Term (v0.x) - Completed
- **Resilient selector healing:** completed via ranked fallback locator chain (test id/id/href/name/role/css path) plus ambiguity ranking and disambiguation.
- **Context-native screenshot handoff (default-on):** completed via automatic attachment publication under `.agent-browser/context/` (`latest.json`, `attachments.jsonl`, latest/archive images).
- **Trace-scoped role switching:** completed via `switchProfile` action for profile selection directly inside scripts/replay sessions.
- **Visual diff assertions:** completed via `assert` condition kind `visual_baseline` with baseline thresholding and diff evidence.

### Prioritized Post-Dogfooding Additions (Impact vs Effort)
- **P0 - Completed: Graceful interrupt/shutdown hardening** (idempotent session/adapter shutdown, cancellable interrupt waiters, close-race noise suppression).
- **P0 - Completed: First-class feedback-loop runner** (`loop` execution mode with action->observe->branch semantics, snapshot/assert predicates, and max-iteration control).
- **P1 - Selector health report (High impact, Medium effort):** emit selector fragility metrics (fallback depth, timeout frequency, ambiguity count) after runs and smoke matrix batches.
- **P1 - Artifact manifest index (Medium impact, Low effort):** produce a single run index that links trace, timeline, screenshots, visual diffs, and top errors for external tool ingestion. (Partial: `bundle.json` currently links trace/timeline/screenshots/interventions.)
- **P1 - Network-aware wait primitives (Medium impact, Medium effort):** add action conditions for response/status/body predicates to reduce DOM-only synchronization flake.
- **P2 - Auto-retry with evidence policy (Medium impact, Medium effort):** optional bounded retries that persist per-attempt evidence and a final retry rationale.
- **P2 - Session identity clarity in adapter responses (Medium impact, Low effort):** standardize and document adapter `sessionId` vs runtime `sessionId` fields to avoid client confusion.
- **P2 - Checkpoint/resume for long flows (Medium impact, High effort):** named checkpoints in scripts with resume-from-checkpoint support after failures.
- **P3 - Cross-site drift monitor (Medium impact, High effort):** aggregate recurring smoke failures and auto-suggest selector strategy updates.
- **P3 - Consent/login plugin registry (Low-Medium impact, Medium effort):** domain adapters for recurring consent and login patterns discovered in smoke runs. (Partial: consent strategy hooks + site adapters exist; formal plugin registry and login adapters still pending.)

### Medium-Term (v1)
- **Parallel session scheduler:** run multiple isolated agent sessions concurrently with stable resource control.
- **Cross-tab/popup orchestration:** first-class primitives for OAuth/payment-style multi-window flows.
- **Network chaos controls:** deterministic latency/drop/fault injection for resilience testing.
- **Plugin SDK:** typed hooks for custom actions, validators, and domain adapters.
- **Goal graph planner:** model tasks as precondition/postcondition graphs instead of only linear scripts.

### Advanced Differentiators
- **DOM+vision grounding:** combine accessibility tree targeting with visual region matching.
- **Counterfactual replay analysis:** rerun failing steps under controlled perturbations to isolate root causes.
- **Policy guardrail engine:** enforce declarative allow/deny rules for navigation, actions, and data movement.
- **Human checkpoint handoff:** pause for approval and let humans take over headed sessions in place.
- **Trace provenance query layer:** answer "why this action" using a searchable action/event graph.

## Agent-IDE Integration (Planned)
- **OpenCode integration adapter:** first-class command wrapper and JSON-RPC bridge so OpenCode agents can send actions and receive structured results without parsing CLI text.
- **Claude Code integration adapter:** slash-command oriented bridge and stable output schema for autonomous browser workflows in Claude Code sessions.
- **OpenAI Codex integration adapter:** lightweight local service exposing action/replay/timeline endpoints with deterministic schema for Codex tool use.
- **Unified SDK contract:** one shared TypeScript/JSON schema for all three integrations to avoid per-agent drift.

## Pause/Resume Runtime (Post-Base Follow-Ups)
- **Completed:** storage/cookie delta journaling with bounded diff samples.
- **Completed:** reconciliation hints attached when URL/DOM/storage drift occurs during pause.
- **Completed:** MCP-parity alias methods (`session.pause|resume|state`) in adapter transport.
- **Next follow-up:** add optional server-side policy for maximum retained intervention journal history.

## Feature Gaps Found During Dogfooding
- **Resolved:** consent/cookie strategy hooks via region-aware + site/CMP selector layering.
- **Resolved:** timeline inspector UI with grouping, search, and row-level detail pane.
- **Resolved:** element-aware diff overlays including target boxes and semantic labels.
- **Resolved:** default screenshot context handoff for immediate feedback loops.
- **New gap:** add filter presets and diff-only focus mode in timeline inspector for very long traces.

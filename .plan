# Agent-First Browser Plan

## Product Goal
Build an agent-first Chromium runtime where structured state is primary, actions are atomic/replayable, and humans can watch execution in a visible browser with real-time logs.

## Locked Constraints
- TypeScript implementation.
- Visible Chromium by default (headed mode).
- Real-time logs and action stream.
- Deterministic-first behavior for reproducible testing.
- Structured DOM snapshots with stable IDs.
- Session save/load and trace replay.

## Architecture
Agent -> Control API -> Orchestrator -> Chromium (Playwright + CDP) -> State/Trace Store

- **Control API:** JSON command contract for actions and results.
- **Orchestrator:** Intent -> atomic operations with stable waits/retries.
- **Runtime:** Browser lifecycle, tabs, contexts, mocks.
- **State Layer:** snapshots, diffs, logs, network, timing, artifacts.

## Feature Pillars
1. **Deterministic Execution**
   - Reduced motion + disabled animations.
   - Fixed seed random/time shims.
   - Wait-for-stable heuristics.
   - Trace replay with consistency checks.

2. **Structured DOM Interface**
   - Node IDs, role/name, visibility, interactability, bbox.
   - Stable semantic references.
   - Token-optimized output mode.

3. **Atomic Action API**
   - navigate/click/fill/select/press/wait/snapshot/mock.
   - Every action returns status + dom diff + logs + network + timings.

4. **Observability**
   - Console, network, page errors, request failures.
   - Layout shift + paint/navigation timing collection.
   - Real-time event feed in CLI.

5. **Persistence + Replay**
   - Save storage state + URL checkpoints.
   - Save action traces to disk.
   - Deterministic replay with hash comparison.

## Initial Deliverables (v0)
- Headed Chromium runtime.
- Action execution engine with deterministic mode.
- Structured snapshot + DOM diff engine.
- Real-time logs + network capture.
- CLI (`open`, `run`, `inspect`, `snapshot`, `replay`).
- Trace save/load and replay validation.

## Current Build Status
- Implemented: headed Chromium runtime, atomic action execution, snapshot/diff engine, observer pipeline, trace save/replay, session save/load.
- Implemented CLI: `open`, `inspect`, `describe`, `run`, `act`, `snapshot`, `load`, `replay`, `flake`.
- Implemented deterministic defaults: reduced motion, random/time shims, layout-shift capture.
- Implemented tests: contract + snapshot unit tests, integration tests for real app flow + replay + session load + ambiguous role disambiguation.
- Implemented batch validation runner: `npm run smoke:sites` for sequential multi-site coverage with JSON summary output.
- Implemented replay upgrades: preflight origin checks, strict/relaxed replay modes, selector-level invariants, and repeated-run flake detection.
- Implemented trace metadata upgrades: environment contract (`requiredOrigins`) and action timeline summaries.
- Implemented log noise controls with default filtering and `--raw-logs` override.
- Implemented viewport control via session options/CLI and script action (`setViewport`).
- Implemented agent-first page modality output (`describe`) with positional metadata and issue hints.
- Implemented timeout-guarded site matrix execution (per-operation and per-action timeouts) to prevent hangs.
- Implemented trace timeline inspection command (`timeline`) with tabular and JSON output.
- Implemented assertion DSL (`assert`) with selector/url/title checks.
- Implemented consent helper action (`handleConsent`) for common cookie/consent banners.
- Implemented adaptive stability profiles (`fast`, `balanced`, `chatty`) for wait tuning.
- Implemented triage bundle generation (`bundle`) for trace+timeline+artifact packaging.
- Implemented interactive confidence scoring in agent page descriptions.
- Implemented screenshot modes (`viewport` default, optional `fullpage`) to reduce visual flashing during runs.
- Implemented bundle artifact copy mode (`bundle --copy-artifacts`) for portable triage packages.
- Implemented configurable redaction policy packs (`default`, `strict`, `off`).
- Implemented named profile aliases (`profile-save`, `profile-load`) for reusable authenticated sessions.
- Implemented visual assertion primitives (`selector_bbox_min`, `selector_overlap_max`).
- Implemented interactive timeline HTML report generation (`timeline-html`).
- Implemented screenshot-based visual regression overlays (`visual-diff`).

## Validation Strategy
- Build local fixture app for dogfooding.
- Run scripted flow against fixture using visible browser.
- Verify per-action diffs/logs/network bundles.
- Run replay and validate expected vs actual DOM hashes.

## Cross-Site Validation Coverage
- Added multi-site scripted flows in `examples/site-flows` for: example, wikipedia, mdn, nodejs, github, python, vite, hn, rust, bbc, react, books.
- Each flow performs navigation + at least one interaction step (click/fill/search).
- Ran matrix repeatedly; latest full pass: 12/12 successful flows with no new blocking bugs.
- Verified replay behavior on dynamic/public traces: strict mode surfaces real DOM drift, relaxed mode validates stable invariants.
- Final consecutive matrix pass after replay/flake enhancements also succeeded: 12/12 sites, 0 failures.

## Executed Fixes from Cross-Site Runs
- Implemented locator candidate fallback chain (test id, id, href, name attr, role/name, css path).
- Implemented strict-mode disambiguation by defaulting target locators to `.first()` and trying ranked alternatives.
- Implemented stableRef ranking to prefer visible/actionable matches when duplicate semantic refs exist.
- Implemented bounded stability waits to avoid 10s stalls on chatty sites (short network-idle budget + quiet window).
- Improved action resilience by degrading gracefully when post-action snapshot/perf/screenshot capture fails.
- Added ambiguous-target fixture + integration test to prevent regressions in multi-match role targeting.
- Added site matrix runner (`npm run smoke:sites`) and machine-readable summary output.
- Added replay preflight checks to fail fast when required origins are offline.
- Added relaxed replay mode for dynamic sites where strict DOM hashes are too brittle.
- Added flake detection command to surface unstable actions across repeated replays.
- Added selector-level replay invariants (from `waitFor(selector)`) for stronger relaxed-mode validation.
- Added viewport/action support to test behavior across resolutions.
- Added offscreen-aware element ranking and visual issue detection in agent page descriptions.
- Added smoke runner timeout flags (`--operation-timeout-ms`, `--action-timeout-ms`) for safer unattended runs.
- Standardized manual run logs under `reports/runtime-logs/` for reproducible audit trails.
- Added timeline filters/artifact visibility for quicker failure triage.
- Added consent and assert integration coverage in fixture tests.
- Enforced headless-by-default behavior in site matrix runs unless explicitly requested (`--headed`).
- Added optional screenshot copying into bundles for offline handoff.
- Replaced unstable npmjs smoke flow (Cloudflare challenge) with nodejs.org flow for deterministic matrix reliability.
- Replaced unstable ebay smoke flow with books.toscrape flow for deterministic e-commerce-style coverage.
- Added profile command wrappers to simplify session save/load workflows for role-based testing.
- Added CLI-level visual diff thresholding and fail conditions for regression gating.

## Definition of Done (v0)
- Browser visible and usable while automation runs.
- Every action emits structured result envelope.
- Trace save + replay works for deterministic scenarios.
- Session state save/load restores authenticated/local state.
- CLI gives clear, real-time debugging output.

## Continuous Roadmap Additions

### Near-Term (v0.x)
- **Resilient selector healing:** rank fallback locators so small DOM changes do not break actions.
- **Trace-scoped role switching:** profile selection directly inside action scripts and replay sessions.
- **Visual diff assertions:** compare screenshots against stored baselines within assert actions.

### Medium-Term (v1)
- **Parallel session scheduler:** run multiple isolated agent sessions concurrently with stable resource control.
- **Cross-tab/popup orchestration:** first-class primitives for OAuth/payment-style multi-window flows.
- **Network chaos controls:** deterministic latency/drop/fault injection for resilience testing.
- **Plugin SDK:** typed hooks for custom actions, validators, and domain adapters.
- **Goal graph planner:** model tasks as precondition/postcondition graphs instead of only linear scripts.

### Advanced Differentiators
- **DOM+vision grounding:** combine accessibility tree targeting with visual region matching.
- **Counterfactual replay analysis:** rerun failing steps under controlled perturbations to isolate root causes.
- **Policy guardrail engine:** enforce declarative allow/deny rules for navigation, actions, and data movement.
- **Human checkpoint handoff:** pause for approval and let humans take over headed sessions in place.
- **Trace provenance query layer:** answer "why this action" using a searchable action/event graph.

## Feature Gaps Found During Dogfooding
- **Action timeline UI:** live-updating timeline view while session runs (current timeline UI is post-run/report-based).
- **Consent/cookie strategy hooks:** extend generic accept/reject logic with site-specific adapters and region-aware variants.
- **Timeline inspector UI:** richer grouping/searching and per-action deep panes beyond current HTML table/filters.
- **Element-aware visual overlays:** annotate diff images with target node boxes and semantic labels.
